<!DOCTYPE HTML>
<html>
<head>
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" integrity="sha384-rwoIResjU2yc3z8GV/NPeZWAv56rSmLldC3R/AZzGRnGxQQKnKkoFVhFQhNUwEyJ" crossorigin="anonymous">
    <script src="//code.jquery.com/jquery-3.1.1.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js" integrity="sha384-DztdAPBWPRXSA/3eYEEUWrWCy7G5KFbe8fFjk5JAIxUYHKkDx6Qin1DkWx51bBrb" crossorigin="anonymous"></script>
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js" integrity="sha384-vBWWzlZJ8ea9aCX4pEW3rVHjgjt7zpkNpZk+02D9phzyeVkE+jo0ieGizqPLForn" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
      // TODO switch to React
      // TODO switch to non-native ws lib
      var wsOpen = false;
      var backoffInterval = 1000;
      var backoffCurrent = backoffInterval;
      function socksOn(reconnect) {
        var ws = new WebSocket("{{.WebSocketURI}}");
        if (reconnect) {
          backoffCurrent += backoffInterval;
          ws.onopen = function(e) {
            wsOpen = true;
            var t = $("#message-template")
              .clone()
              .prop("id", "");
            t.find('.card-title').text('<system>');
            t.find('.card-text').text('reconnected.');
            t.find('.card-subtitle').text(moment().format());
            t.find('.card-image').hide();
            t
              .show()
              .appendTo($('.messages'));
          };
        } else {
          ws.onopen = function(){ wsOpen = true };
        }
        ws.onclose = function(e) {
          if (wsOpen && reconnect) {
            wsOpen = false;
            var t = $("#message-template")
              .clone()
              .prop("id", "");
            t.find('.card-title').text('<system>');
            t.find('.card-text').text('connection closed... reconnecting...');
            t.find('.card-subtitle').text(moment().format());
            t.find('.card-image').hide();
            t
              .show()
              .appendTo($('.messages'));
          }
          setTimeout(function(){ socksOn(true); }, backoffCurrent);
        };
        ws.onmessage = function(e) {
          var msg = JSON.parse(e.data);
          switch(msg.type) {
            case "team-info":
              $("#header-channel").text(msg.channel);
              $("#header-slack").text(msg.slack);
              break;
            case "message":
              var t = $("#message-template")
                .clone()
                .attr("id", "")
                .data("message", msg.ts);

              if(msg.user) {
                t.find('.card-image').prop('src', msg.user.avatar_url);
              } else {
                t.find('.card-image').hide();
              }
              t.find('.card-title').text(msg.user ? msg.user.username : '');
              t.find('.card-text').text(msg.text || '');
              // TODO sigils and whatnot
              var ts = moment(msg.ts * 1000) // epoch;
              t.find('.card-subtitle').text(ts.format());

              t
                .show()
                .appendTo($('.messages'));
              break;  
            default:
              console.log("Unhandled message", msg);
          }
        };
      }
      socksOn(false); 
    </script>
</head>
<body>
	<div class="container">
    <div class="header" style='border-bottom: 1px solid #eee'>
      <h3 class="text-muted"><span id='header-slack'></span> Slack <small>(read only)</small></h3>
      <h4 class="text-muted"><span id='header-channel'></span></h4>
    </div>
    <div class="messages">
			<div class="card" style='display:none;margin-top:5px' id='message-template'>
				<div class="card-block" style='padding:.5rem'>
          <div style='float:left'><img style='width:80px;height:80px;margin-right:5px' class='card-image'/></div>
          <div style='float:left'>
            <h4 class="card-title"></h4>
            <h6 class="card-subtitle mb-2 text-muted"></h6>
            <p class="card-text" style='overflow:auto'></p>
            <!--a href="#" class="card-link">Card link</a-->
            <!--a href="#" class="card-link">Another link</a-->
          </div>
				</div>
			</div>
    </div>
	</div>
</body>

</html>
